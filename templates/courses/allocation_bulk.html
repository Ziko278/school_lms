{% extends 'base/base_admin.html' %}
{% load static %}

{% block title %}Bulk Course Allocation | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Bulk Course Allocation</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Allocate Multiple Courses</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Step 1: Session/Semester Selection & Filter Form -->
                    <form method="get" id="filterForm" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label for="{{ form.session.id_for_label }}" class="form-label">{{ form.session.label }}</label>
                            {{ form.session }}
                        </div>
                         <div class="col-md-3">
                            <label for="{{ form.semester.id_for_label }}" class="form-label">{{ form.semester.label }}</label>
                            {{ form.semester }}
                        </div>
                        <div class="col-md-3">
                            <label for="departmentFilterBulk" class="form-label">Filter by Department</label>
                            <select id="departmentFilterBulk" name="department" class="form-select form-select-sm">
                                <option value="">All Departments</option>
                                {% for dept in departments %} {# Pass departments from view context #}
                                    <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == request.GET.department %}selected{% endif %}>{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                             <label for="levelFilterBulk" class="form-label">Filter by Level</label>
                            <select id="levelFilterBulk" name="level" class="form-select form-select-sm">
                                <option value="">All Levels</option>
                                {% for level in levels %} {# Pass levels from view context #}
                                     <option value="{{ level.id }}" {% if level.id|stringformat:"s" == request.GET.level %}selected{% endif %}>{{ level.name }} ({{ level.program.department.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-filter"></i> Load</button>
                        </div>
                    </form>
                    <hr>

                    <!-- Step 2: Allocation Table (shown after session/semester selected) -->
                    {% if request.GET.session and request.GET.semester %}
                    <form method="post" action="{% url 'courses:allocation_bulk' %}" id="bulkAllocationForm">
                         {% csrf_token %}
                         <input type="hidden" name="session" value="{{ request.GET.session }}">
                         <input type="hidden" name="semester" value="{{ request.GET.semester }}">

                        <div class="alert alert-info small">
                            Showing courses for <strong>{{ selected_session_obj.name }} / {{ selected_semester_obj.get_name_display }}</strong>.
                            {% if request.GET.department %}Filtered by Department: <strong>{{ selected_department_obj.name }}</strong>.{% endif %}
                            {% if request.GET.level %}Filtered by Level: <strong>{{ selected_level_obj.name }}</strong>.{% endif %}
                            Select a lecturer for each course you wish to allocate/update. Leave blank to skip.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Course Code</th>
                                        <th>Course Title</th>
                                        <th>Department</th>
                                        <th>Level</th>
                                        <th>Current Lecturer</th>
                                        <th>Allocate To</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for course_obj in courses_to_allocate %} {# Pass courses_to_allocate from view #}
                                    <tr>
                                        <td>{{ course_obj.code }}</td>
                                        <td>{{ course_obj.title }}</td>
                                        <td>{{ course_obj.department.code }}</td>
                                        <td>{{ course_obj.level.name }}</td>
                                        <td>
                                            {% with current_alloc=course_obj.current_allocation %} {# Pass current_allocation with course #}
                                                {% if current_alloc %}
                                                    <span class="badge bg-secondary">{{ current_alloc.lecturer.user.get_full_name }}</span>
                                                {% else %}
                                                    <span class="text-muted small">None</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <select name="lecturer_{{ course_obj.id }}" class="form-select form-select-sm lecturer-select" data-department="{{ course_obj.department.id }}">
                                                <option value="">-- Select Lecturer --</option>
                                                 {# Options populated by JS or pre-filtered in view #}
                                                 {% for lecturer in lecturers %} {# Pass all lecturers initially #}
                                                    <option value="{{ lecturer.id }}" {% if course_obj.current_allocation and course_obj.current_allocation.lecturer.id == lecturer.id %}selected{% endif %} data-department-id="{{ lecturer.department.id }}">
                                                        {{ lecturer.user.get_full_name }} {% if lecturer.department %}({{ lecturer.department.code }}){% endif %}
                                                    </option>
                                                 {% endfor %}
                                            </select>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No courses found matching your filter criteria for the selected session/semester.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if courses_to_allocate %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-success"><i class="bi bi-check-circle me-1"></i> Allocate Selected Courses</button>
                            <a href="{% url 'courses:allocation_list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                        {% endif %}
                    </form>
                    {% else %}
                    <p class="text-muted text-center">Please select a Session and Semester above to load courses for allocation.</p>
                    {% endif %}

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Optional: Filter lecturer dropdowns based on course department for convenience
    document.addEventListener('DOMContentLoaded', function() {
        const lecturerSelects = document.querySelectorAll('.lecturer-select');

        lecturerSelects.forEach(select => {
            const courseDepartmentId = select.dataset.department;
            if (!courseDepartmentId) return;

            const options = Array.from(select.options);
            // Optionally hide or prioritize lecturers from the same department
            options.forEach(option => {
                 if (option.value && option.dataset.departmentId && option.dataset.departmentId !== courseDepartmentId) {
                     // Example: Dim or move non-department lecturers down
                     // option.style.color = '#aaa';
                 }
            });

             // You could also dynamically fetch lecturers for the specific department via AJAX
             // when the row loads or when the department filter changes.
        });

         // Logic to filter semesters based on selected session (similar to single allocation form)
        const sessionSelect = document.getElementById('{{ form.session.id_for_label }}');
        const semesterSelect = document.getElementById('{{ form.semester.id_for_label }}');
        if(sessionSelect && semesterSelect) {
            const originalSemesterOpts = Array.from(semesterSelect.options);
            sessionSelect.addEventListener('change', function() {
                const selectedSessId = this.value;
                semesterSelect.innerHTML = ''; // Clear
                 originalSemesterOpts.forEach(opt => {
                     // Assuming semester option text includes session name like "(2024/2025)"
                     // Or better: add data-session-id attribute in the form definition
                     const optionSessId = opt.dataset.sessionId; // Need to add this data attribute
                     if (!opt.value || !selectedSessId || optionSessId === selectedSessId) {
                         semesterSelect.appendChild(opt.cloneNode(true));
                     }
                 });
                 // Restore previous selection if applicable
                 const prevSem = '{{ request.GET.semester|default:"" }}';
                 if (prevSem && semesterSelect.querySelector(`option[value="${prevSem}"]`)) {
                     semesterSelect.value = prevSem;
                 } else {
                     semesterSelect.value = '';
                 }
            });

             // Add data-session-id attribute
             originalSemesterOpts.forEach(option => {
                 if (option.value) {
                     const match = option.textContent.match(/\(([^)]+)\)$/);
                     if (match && match[1]) {
                         const sessionOption = Array.from(sessionSelect.options).find(sOpt => sOpt.textContent === match[1]);
                         if (sessionOption) {
                             option.dataset.sessionId = sessionOption.value;
                         }
                     }
                 }
             });

            // Initial trigger
            sessionSelect.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}
