{% extends 'base/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Course Allocations | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Course Allocations</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Manage Course Allocations</h5>
                         <div>
                             <a href="{% url 'courses:allocation_create' %}" class="btn btn-primary btn-sm me-1"><i class="bi bi-person-plus me-1"></i> Allocate Single</a>
                             <a href="{% url 'courses:allocation_bulk' %}" class="btn btn-success btn-sm"><i class="bi bi-people me-1"></i> Bulk Allocate</a>
                         </div>
                    </div>

                    {% include 'components/alerts.html' %}

                    <!-- Filter Form -->
                    <form method="get" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label for="session" class="form-label form-label-sm">Session</label>
                            <select id="session" name="session" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for sess in sessions %}
                                <option value="{{ sess.id }}" {% if sess.id|stringformat:"s" == selected_session %}selected{% endif %}>{{ sess.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="semester" class="form-label form-label-sm">Semester</label>
                            <select id="semester" name="semester" class="form-select form-select-sm">
                                <option value="">All</option>
                                {# Note: This loads all semesters. Ideally, filter by selected session via JS #}
                                {% for sem in semesters %}
                                <option value="{{ sem.id }}" {% if sem.id|stringformat:"s" == selected_semester %}selected{% endif %}>{{ sem.get_name_display }} ({{ sem.session.name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-3">
                            <label for="department" class="form-label form-label-sm">Department</label>
                            <select id="department" name="department" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department %}selected{% endif %}>{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="lecturer" class="form-label form-label-sm">Lecturer</label>
                            <select id="lecturer" name="lecturer" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for lec in lecturers %}
                                <option value="{{ lec.id }}" {% if lec.id|stringformat:"s" == selected_lecturer %}selected{% endif %}>{{ lec.user.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-filter"></i></button>
                        </div>
                    </form>

                    <!-- Allocations Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable-custom">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Course</th>
                                    <th scope="col">Lecturer</th>
                                    <th scope="col">Session</th>
                                    <th scope="col">Semester</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alloc in allocations_page %}
                                <tr>
                                    <th scope="row">{{ forloop.counter0|add:allocations_page.start_index }}</th>
                                    <td><a href="{% url 'courses:course_detail' alloc.course.id %}">{{ alloc.course.code }} - {{ alloc.course.title }}</a></td>
                                    <td><a href="{% url 'accounts:staff_detail' alloc.lecturer.id %}">{{ alloc.lecturer.user.get_full_name }}</a></td>
                                    <td>{{ alloc.session.name }}</td>
                                    <td>{{ alloc.semester.get_name_display }}</td>
                                    <td>
                                         <button type="button" class="btn btn-danger btn-sm" title="Remove Allocation" data-bs-toggle="modal" data-bs-target="#deleteAllocationModal{{ alloc.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>

                                 <!-- Delete Confirmation Modal -->
                                <div class="modal fade" id="deleteAllocationModal{{ alloc.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                            <h5 class="modal-title">Confirm Removal</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                            Are you sure you want to remove the allocation of <strong>{{ alloc.course.code }}</strong> from <strong>{{ alloc.lecturer.user.get_full_name }}</strong> for the {{ alloc.semester.get_name_display }}, {{ alloc.session.name }} session?
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form action="{% url 'courses:allocation_delete' alloc.id %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger">Remove Allocation</button>
                                            </form>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- End Delete Modal -->

                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No course allocations found matching your criteria.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Allocations Table -->

                     {% include 'components/pagination.html' with page_obj=allocations_page %}

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Optional: Add JavaScript to dynamically filter semesters based on selected session
    const sessionSelect = document.getElementById('session');
    const semesterSelect = document.getElementById('semester');

    if (sessionSelect && semesterSelect) {
        // Store original options
        const originalSemesterOptions = Array.from(semesterSelect.options);

        sessionSelect.addEventListener('change', function() {
            const selectedSessionId = this.value;
            // Clear current options (except the "All")
            semesterSelect.innerHTML = '';
            semesterSelect.appendChild(originalSemesterOptions[0]); // Add back "All"

            if (selectedSessionId) {
                // Filter and add relevant options
                originalSemesterOptions.forEach(option => {
                    // Check if option text contains the session name or ID (adjust logic as needed)
                    // This is a basic check assuming format "Semester (Session Name)"
                    if (option.value && option.dataset.sessionId === selectedSessionId) {
                         semesterSelect.appendChild(option.cloneNode(true));
                    }
                     // If you store session ID in a data attribute:
                     // const optionSessionId = option.getAttribute('data-session-id');
                     // if (option.value && optionSessionId === selectedSessionId) {
                     //     semesterSelect.appendChild(option.cloneNode(true));
                     // }
                });
            } else {
                 // If "All Sessions" is selected, add all options back
                 originalSemesterOptions.slice(1).forEach(option => {
                     semesterSelect.appendChild(option.cloneNode(true));
                 });
            }
             // Restore previously selected semester if it's still valid
             const previouslySelected = '{{ selected_semester|default:"" }}';
             if (previouslySelected && semesterSelect.querySelector(`option[value="${previouslySelected}"]`)) {
                 semesterSelect.value = previouslySelected;
             }
        });

         // Add data-session-id attribute to semester options on load
         originalSemesterOptions.forEach(option => {
             const match = option.textContent.match(/\(([^)]+)\)$/); // Extract session name like (2024/2025)
             if (match && match[1]) {
                 // Find corresponding session option to get its ID
                 const sessionOption = Array.from(sessionSelect.options).find(sOpt => sOpt.textContent === match[1]);
                 if (sessionOption) {
                    option.dataset.sessionId = sessionOption.value;
                 }
             }
         });

        // Trigger change on load to filter based on initial selection
        sessionSelect.dispatchEvent(new Event('change'));
    }
</script>
{% endblock %}
