{% extends 'base/base_student.html' %}
{% load static %}
{% load humanize %}

{% block title %}My Registered Courses | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>My Registered Courses</h1>
     <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">My Courses</li>
        </ol>
      </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Registered Courses</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Filter Form -->
                    <form method="get" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-4">
                            <label for="session" class="form-label form-label-sm">Session</label>
                            <select id="session" name="session" class="form-select form-select-sm">
                                <option value="">All History</option>
                                {% for sess in sessions %}
                                <option value="{{ sess.id }}" {% if sess.id == selected_session %}selected{% endif %}>{{ sess.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="semester" class="form-label form-label-sm">Semester</label>
                            <select id="semester" name="semester" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for sem in semesters %}
                                {# Ideally filter by session selection via JS #}
                                <option value="{{ sem.id }}" {% if sem.id == selected_semester %}selected{% endif %}>{{ sem.get_name_display }} ({{ sem.session.name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                             <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-filter"></i> Filter</button>
                        </div>
                         <div class="col-md-2 text-end">
                              <a href="{% url 'courses:student_register' %}" class="btn btn-success btn-sm"><i class="bi bi-plus-lg me-1"></i> Register New</a>
                        </div>
                    </form>
                     <hr>

                    <!-- Summary -->
                    <div class="mb-3 small text-muted">
                        Showing results for:
                        {% if selected_session_obj %}{{ selected_session_obj.name }}{% else %}All Sessions{% endif %}
                        {% if selected_semester_obj %} / {{ selected_semester_obj.get_name_display }}{% endif %}.
                        <br>
                        Total Approved Credit Units for this view: <strong>{{ total_units }}</strong>
                    </div>

                    <!-- Registrations Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Course Code</th>
                                    <th scope="col">Course Title</th>
                                    <th scope="col">Units</th>
                                    <th scope="col">Session</th>
                                    <th scope="col">Semester</th>
                                    {# Add Lecturer column if available in context #}
                                    <th scope="col">Registered On</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reg in registrations %}
                                <tr>
                                    <th scope="row">{{ forloop.counter }}</th>
                                    <td>{{ reg.course.code }}</td>
                                    <td>{{ reg.course.title }}</td>
                                    <td>{{ reg.course.credit_units }}</td>
                                    <td>{{ reg.session.name }}</td>
                                    <td>{{ reg.semester.get_name_display }}</td>
                                    <td>{{ reg.registration_date|date:"Y-m-d H:i" }}</td>
                                     <td>
                                        <span class="badge
                                            {% if reg.status == 'pending' %} bg-warning text-dark
                                            {% elif reg.status == 'approved' %} bg-success
                                            {% elif reg.status == 'rejected' %} bg-danger
                                            {% else %} bg-secondary {% endif %}">
                                            {{ reg.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No registered courses found for the selected period. <a href="{% url 'courses:student_register' %}">Register now?</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Registrations Table -->

                     {# Add pagination if registrations object is paginated #}
                     {# {% include 'components/pagination.html' with page_obj=registrations %} #}

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Optional: Add JavaScript to dynamically filter semesters based on selected session
    const sessionSelect = document.getElementById('session');
    const semesterSelect = document.getElementById('semester');
    if (sessionSelect && semesterSelect) {
        const originalSemesterOptions = Array.from(semesterSelect.options);
        sessionSelect.addEventListener('change', function() {
            const selectedSessionId = this.value;
            semesterSelect.innerHTML = '';
            semesterSelect.appendChild(originalSemesterOptions[0]); // Add "All" back

            if (selectedSessionId) {
                originalSemesterOptions.forEach(option => {
                    // Check if option text contains the session name or ID
                    // This assumes format "Semester (Session Name)" or similar
                    // Or ideally, add `data-session-id="{{ sem.session.id }}"` to the option in the template
                    if (option.value && option.dataset.sessionId === selectedSessionId) { // Check data attribute
                         semesterSelect.appendChild(option.cloneNode(true));
                    }
                     // Fallback text check (less reliable)
                     // const sessionName = sessionSelect.options[sessionSelect.selectedIndex].text;
                     // if (option.value && option.textContent.includes(`(${sessionName})`)) {
                     //     semesterSelect.appendChild(option.cloneNode(true));
                     // }
                });
            } else {
                 originalSemesterOptions.slice(1).forEach(option => {
                     semesterSelect.appendChild(option.cloneNode(true));
                 });
            }
             // Restore previous selection if valid
             const previouslySelected = '{{ selected_semester|default:"" }}';
             if (previouslySelected && semesterSelect.querySelector(`option[value="${previouslySelected}"]`)) {
                 semesterSelect.value = previouslySelected;
             }
        });

         // Add data-session-id to options on load
          originalSemesterOptions.forEach(option => {
             if (option.value) {
                 const match = option.textContent.match(/\(([^)]+)\)$/);
                 if (match && match[1]) {
                     const sessionOption = Array.from(sessionSelect.options).find(sOpt => sOpt.textContent === match[1]);
                     if (sessionOption) {
                         option.dataset.sessionId = sessionOption.value;
                     }
                 }
             }
         });

         // Trigger on load
         sessionSelect.dispatchEvent(new Event('change'));
    }
</script>
{% endblock %}
