{% extends 'base/base_student.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ recording.title }} | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>View Recording</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'virtual_class:student_recording_list' %}">Recordings</a></li>
            <li class="breadcrumb-item active">{{ recording.title|truncatechars:30 }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ recording.title }}</h5>

                    <div class="row">
                        <div class="col-md-8">
                             {% if recording.recording_file %}
                                {# HTML5 Video/Audio Player #}
                                {% with file_url_lower=recording.recording_file.url|lower %}
                                    {% if 'video' in file_url_lower or '.mp4' in file_url_lower or '.mov' in file_url_lower or '.webm' in file_url_lower or '.avi' in file_url_lower or '.mkv' in file_url_lower %}
                                        <div class="ratio ratio-16x9">
                                            <video controls preload="metadata" class="w-100 bg-dark">
                                                <source src="{{ recording.recording_file.url }}"> {# Let browser detect type #}
                                                Your browser does not support the video tag. <a href="{{ recording.recording_file.url }}">Download it here</a>.
                                            </video>
                                        </div>
                                    {% elif 'audio' in file_url_lower or '.mp3' in file_url_lower or '.wav' in file_url_lower or '.ogg' in file_url_lower or '.m4a' in file_url_lower %}
                                        <audio controls preload="metadata" class="w-100 mt-3">
                                            <source src="{{ recording.recording_file.url }}"> {# Let browser detect type #}
                                            Your browser does not support the audio element. <a href="{{ recording.recording_file.url }}">Download it here</a>.
                                        </audio>
                                    {% else %}
                                        <div class="alert alert-light" role="alert">
                                            <i class="bi bi-file-earmark me-2"></i>
                                            File type cannot be previewed directly.
                                            <a href="{{ recording.recording_file.url }}" class="btn btn-primary btn-sm ms-3" download>
                                                <i class="bi bi-download me-1"></i> Download File
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endwith %}

                            {% elif recording.recording_link %}
                                {# Embedded Player or Link #}
                                {% if 'youtube.com' in recording.recording_link or 'youtu.be' in recording.recording_link %}
                                    {# Extract YouTube ID - Improved version #}
                                    {% with youtube_id=None %}
                                        {% if "v=" in recording.recording_link %}
                                            {% with video_part=recording.recording_link|split:"v="|last %}
                                                {% with video_id=video_part|split:"&"|first %}
                                                    {% if video_id|length == 11 %} {# Basic check for ID length #}
                                                         {% with youtube_id=video_id %}
                                                            <div class="ratio ratio-16x9">
                                                                <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                            </div>
                                                         {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endwith %}
                                        {% elif "youtu.be/" in recording.recording_link %}
                                             {% with video_part=recording.recording_link|split:"youtu.be/"|last %}
                                                {% with video_id=video_part|split:"?"|first %}
                                                     {% if video_id|length == 11 %}
                                                         {% with youtube_id=video_id %}
                                                            <div class="ratio ratio-16x9">
                                                                <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                            </div>
                                                         {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if not youtube_id %} {# Fallback if ID extraction failed #}
                                            <div class="alert alert-warning" role="alert">Could not embed YouTube video. <a href="{{ recording.recording_link }}" target="_blank">Open Link</a></div>
                                        {% endif %}
                                    {% endwith %}
                                {% elif 'vimeo.com' in recording.recording_link %}
                                     {# Extract Vimeo ID #}
                                     {% with vimeo_id=recording.recording_link|split:"/"|last|split:"?"|first %}
                                        {% if vimeo_id and vimeo_id|isdigit %}
                                             <div class="ratio ratio-16x9">
                                                  <iframe src="https://player.vimeo.com/video/{{ vimeo_id }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                                             </div>
                                        {% else %}
                                             <div class="alert alert-warning" role="alert">Could not embed Vimeo video. <a href="{{ recording.recording_link }}" target="_blank">Open Link</a></div>
                                        {% endif %}
                                     {% endwith %}
                                {% else %}
                                     <div class="alert alert-light" role="alert">
                                        <i class="bi bi-link-45deg me-2"></i>
                                        External recording link:
                                        <a href="{{ recording.recording_link }}" target="_blank" rel="noopener noreferrer" class="btn btn-info btn-sm ms-3 text-white">
                                            <i class="bi bi-box-arrow-up-right me-1"></i> Open Link
                                        </a>
                                    </div>
                                {% endif %}

                            {% else %}
                                <div class="alert alert-warning text-center" role="alert">
                                    No recording file or link available for this entry.
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h6>Details</h6>
                            <ul class="list-unstyled">
                                <li><strong>Course:</strong> {{ recording.course_allocation.course.code }}</li>
                                <li><strong>Date:</strong> {{ recording.date_recorded|date:"M d, Y" }}</li>
                                <li><strong>Duration:</strong> {{ recording.duration|default:"N/A" }}</li>
                                {% if recording.recording_file %}
                                <li><strong>File:</strong> <a href="{{ recording.recording_file.url }}" download>{{ recording.recording_file.name|slice:":30" }}{% if recording.recording_file.name|length > 30 %}...{% endif %}</a></li>
                                {% endif %}
                                 {% if recording.recording_link %}
                                <li><strong>Link:</strong> <a href="{{ recording.recording_link }}" target="_blank" rel="noopener noreferrer">{{ recording.recording_link|truncatechars:40 }}</a></li>
                                {% endif %}
                            </ul>

                             {% if recording.notes %}
                             <h6 class="mt-3">Notes</h6>
                             <p class="small text-muted">{{ recording.notes|linebreaksbr }}</p>
                             {% endif %}

                             <div class="mt-4">
                                  <a href="{% url 'virtual_class:student_recording_list' %}" class="btn btn-secondary btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i> Back to Recordings
                                </a>
                             </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{# Add any JS needed for custom player integration if required #}
<style>
/* Add any specific styling for the video/audio player if needed */
video, audio {
    max-width: 100%;
}
iframe {
    max-width: 100%;
}
</style>
{% endblock %}

