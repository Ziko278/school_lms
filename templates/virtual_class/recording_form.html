{% extends 'base/base_staff.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{% if recording %}Edit{% else %}Upload{% endif %} Recording | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>{% if recording %}Edit{% else %}Upload{% endif %} Class Recording</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'virtual_class:recording_list' %}">Recordings</a></li>
            <li class="breadcrumb-item active">{% if recording %}Edit{% else %}Upload{% endif %}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recording Details</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Recording Form -->
                    <form method="POST" action="" enctype="multipart/form-data" class="row g-3 needs-validation" id="recordingForm" novalidate>
                        {% csrf_token %}

                        <div class="col-md-12">
                            <label for="{{ form.course_allocation.id_for_label }}" class="form-label">{{ form.course_allocation.label }} <span class="text-danger">*</span></label>
                            {% render_field form.course_allocation class="form-select" required=True %}
                             {% if form.course_allocation.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.course_allocation.errors|first }}
                                </div>
                             {% else %}
                                <div class="invalid-feedback">Please select the course allocation.</div>
                            {% endif %}
                            <small class="text-muted">Select the course this recording belongs to (current session/semester).</small>
                        </div>

                         <div class="col-md-12">
                            <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }} <span class="text-danger">*</span></label>
                            {% render_field form.title class="form-control" required=True placeholder="E.g., Lecture 1 - Introduction to..." %}
                             <div class="invalid-feedback">{{ form.title.errors|first|default:"Please provide a title." }}</div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.recording_file.id_for_label }}" class="form-label">{{ form.recording_file.label }}</label>
                            {% render_field form.recording_file class="form-control" %}
                            {% if recording and recording.recording_file %}
                            <small class="text-muted">Current file: <a href="{{ recording.recording_file.url }}" target="_blank">{{ recording.recording_file.name|slice:":30" }}...</a><br>Uploading a new file will replace the current one.</small>
                            {% endif %}
                             <div class="invalid-feedback">{{ form.recording_file.errors|first }}</div>
                             <small class="text-muted">Upload a video or audio file (MP4, MP3, etc.).</small>
                        </div>

                        <div class="col-md-6">
                             <label for="{{ form.recording_link.id_for_label }}" class="form-label">{{ form.recording_link.label }}</label>
                            {% render_field form.recording_link class="form-control" placeholder="https://..." type="url" %}
                             <div class="invalid-feedback">{{ form.recording_link.errors|first }}</div>
                             <small class="text-muted">Or provide a link to an external recording (e.g., YouTube, Vimeo).</small>
                        </div>

                        <div class="col-12 text-center text-muted small">
                             <i class="bi bi-info-circle"></i> Please provide either a file OR an external link. If both are provided, the file will take precedence.
                        </div>


                        <div class="col-md-6">
                            <label for="{{ form.date_recorded.id_for_label }}" class="form-label">{{ form.date_recorded.label }} <span class="text-danger">*</span></label>
                             {% render_field form.date_recorded class="form-control" required=True type="date" %}
                            <div class="invalid-feedback">{{ form.date_recorded.errors|first|default:"Please select the date recorded." }}</div>
                        </div>

                         <div class="col-md-6">
                            <label for="{{ form.duration.id_for_label }}" class="form-label">{{ form.duration.label }}</label>
                            {% render_field form.duration class="form-control" placeholder="e.g., 1h 30m, 45min" %}
                            <div class="invalid-feedback">{{ form.duration.errors|first }}</div>
                         </div>

                        <div class="col-12">
                             <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                             {% render_field form.notes class="form-control" rows="3" placeholder="Optional: Add notes or a brief description..." %}
                             <div class="invalid-feedback">{{ form.notes.errors|first }}</div>
                        </div>


                        <div class="text-center mt-4">
                            {# Add progress bar container #}
                             <div class="progress mb-3" id="uploadProgressContainer" style="display: none;">
                                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="saveRecordingBtn">
                                <i class="bi bi-save me-1"></i> {% if recording %}Update{% else %}Upload{% endif %} Recording
                            </button>
                            <a href="{% url 'virtual_class:recording_list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form><!-- End Recording Form -->

                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  'use strict';
  // Standard Bootstrap validation setup
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');

       // Custom validation: Ensure either file or link is provided
       const fileInput = form.querySelector('#{{ form.recording_file.id_for_label }}');
       const linkInput = form.querySelector('#{{ form.recording_link.id_for_label }}');
       
       // Only enforce on create if editing allows removing both
       // If editing requires at least one, remove the 'not recording' check
       {% if not recording %} 
       if (fileInput && linkInput && !fileInput.value && !linkInput.value) {
            event.preventDefault();
            event.stopPropagation();
            linkInput.setCustomValidity('Please provide either a file or a link.'); // Trick BS validation
            linkInput.classList.add('is-invalid'); // Manually show error state
            
            // Add a user-friendly alert or message near the fields
            let errorDiv = form.querySelector('.file-link-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'col-12 alert alert-danger alert-dismissible fade show file-link-error';
                errorDiv.role = 'alert';
                errorDiv.innerHTML = 'Please provide either a recording file or an external link.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                linkInput.closest('.col-md-6').insertAdjacentElement('afterend', errorDiv); 
            }
            errorDiv.style.display = 'block';
       } else if (linkInput) {
           linkInput.setCustomValidity(''); // Clear custom validity if one is provided
           linkInput.classList.remove('is-invalid');
           let errorDiv = form.querySelector('.file-link-error');
            if (errorDiv) errorDiv.style.display = 'none';
       }
       {% endif %}

    }, false);
  });

   // Basic AJAX Upload with Progress 
   const form = document.getElementById('recordingForm');
   const progressBar = document.getElementById('uploadProgressBar');
   const progressContainer = document.getElementById('uploadProgressContainer');
   const saveButton = document.getElementById('saveRecordingBtn');

   if (form && progressBar && progressContainer && saveButton) {
       form.addEventListener('submit', function(e) {
           const fileInput = document.getElementById('{{ form.recording_file.id_for_label }}');
           // Check if a file is actually selected for upload
           if (fileInput && fileInput.files.length > 0) {
               e.preventDefault(); // Prevent default only if uploading via AJAX

               const formData = new FormData(form);
               const xhr = new XMLHttpRequest();

               xhr.open('POST', form.action, true);
               xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
               xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest'); 

               xhr.upload.onprogress = function(event) {
                   if (event.lengthComputable) {
                       const percentComplete = Math.round((event.loaded / event.total) * 100);
                       progressBar.style.width = percentComplete + '%';
                       progressBar.textContent = percentComplete + '%';
                       progressBar.setAttribute('aria-valuenow', percentComplete);
                   }
               };

               xhr.onloadstart = function() {
                   progressContainer.style.display = 'block';
                   saveButton.disabled = true;
                   saveButton.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Uploading...`;
               };

               xhr.onload = function() {
                   if (xhr.status >= 200 && xhr.status < 400) { // Allow redirects (3xx)
                       // Check if it was a JSON response (for potential errors) or redirect
                       if (xhr.getResponseHeader('Content-Type')?.includes('application/json')) {
                           try {
                                const data = JSON.parse(xhr.responseText);
                                if (data.success) {
                                    window.location.href = "{% url 'virtual_class:recording_list' %}?uploaded=true"; 
                                } else {
                                     // Display specific errors
                                    let errorMsg = data.message || 'Upload failed due to server validation.';
                                    if (data.errors) {
                                        errorMsg += '\nDetails: ' + JSON.stringify(data.errors);
                                    }
                                    alert(errorMsg);
                                    resetFormState();
                                }
                           } catch(e) {
                                alert('Upload finished, but unexpected response received.');
                                resetFormState();
                           }
                       } else {
                            // Assume success if not JSON (likely redirect response from Django)
                            window.location.href = "{% url 'virtual_class:recording_list' %}?uploaded=true";
                       }
                   } else {
                       // Handle HTTP error status
                       alert('Upload failed: ' + xhr.statusText + ' (Status: ' + xhr.status + ')');
                       resetFormState();
                   }
               };

               xhr.onerror = function() {
                   alert('An error occurred during the upload (e.g., network issue).');
                   resetFormState();
               };

               xhr.send(formData);
           }
           // If no file selected, let the normal form submission proceed 
       });
   }

    function resetFormState() {
        progressContainer.style.display = 'none';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        saveButton.disabled = false;
        saveButton.innerHTML = `<i class="bi bi-save me-1"></i> {% if recording %}Update{% else %}Upload{% endif %} Recording`;
    }

})();
</script>
<style>
/* Optional: Style the progress bar */
#uploadProgressContainer { height: 20px; }
</style>
{% endblock %}

