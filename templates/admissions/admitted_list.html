{% extends 'base/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Admitted Students | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Admitted Students List</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Manage Admitted Students</h5>
                         <a href="{% url 'admissions:upload_admitted' %}" class="btn btn-success btn-sm"><i class="bi bi-cloud-upload me-1"></i> Upload List (Excel)</a>
                    </div>

                    {% include 'components/alerts.html' %}

                    <!-- Filter & Search Form -->
                    <form method="get" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-2">
                            <label for="status" class="form-label form-label-sm">Status</label>
                            <select id="status" name="status" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for value, display in status_choices %}
                                <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-2">
                            <label for="session" class="form-label form-label-sm">Session</label>
                            <select id="session" name="session" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for sess in sessions %}
                                <option value="{{ sess.id }}" {% if sess.id|stringformat:"s" == selected_session %}selected{% endif %}>{{ sess.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="department" class="form-label form-label-sm">Department</label>
                            <select id="department" name="department" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department %}selected{% endif %}>{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search" class="form-label form-label-sm visually-hidden">Search</label>
                            <input type="text" id="search" class="form-control form-control-sm" name="search" placeholder="Search JAMB No, Name, Email..." value="{{ search_query|default:'' }}">
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search"></i></button>
                        </div>
                    </form>

                    <!-- Admitted Students Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable-custom">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">JAMB No.</th>
                                    <th scope="col">Full Name</th>
                                    <th scope="col">Department</th>
                                    <th scope="col">Program</th>
                                    <th scope="col">PIN</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in admitted_page %}
                                <tr>
                                    <th scope="row">{{ forloop.counter0|add:admitted_page.start_index }}</th>
                                    <td>{{ student.jamb_registration_number }}</td>
                                    <td>{{ student.first_name }} {{ student.last_name }}</td>
                                    <td>{{ student.department.code }}</td>
                                    <td>{{ student.program.name }}</td>
                                    <td>
                                        <span class="admission-pin" title="Click to reveal">{{ student.admission_pin|slice:":3" }}*******</span>
                                        <span class="revealed-pin d-none">{{ student.admission_pin }}</span>
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if student.admission_status == 'pending' %} bg-warning text-dark
                                            {% elif student.admission_status == 'completed' %} bg-success
                                            {% elif student.admission_status == 'expired' %} bg-danger
                                            {% else %} bg-secondary {% endif %}">
                                            {{ student.get_admission_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'admissions:admitted_detail' student.id %}" class="btn btn-info btn-sm" title="View Details"><i class="bi bi-eye"></i></a>
                                        {% if student.admission_status == 'pending' %}
                                        <button type="button" class="btn btn-primary btn-sm resend-email-btn" data-id="{{ student.id }}" title="Resend Admission Email">
                                            <i class="bi bi-envelope"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No admitted students found matching your criteria.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Admitted Students Table -->

                     {% include 'components/pagination.html' with page_obj=admitted_page %}

                </div>
            </div>

        </div>
    </div>
</section>

<!-- Resend Email Form (Hidden) -->
<form id="resendEmailForm" method="post" class="d-none">
    {% csrf_token %}
</form>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Reveal Admission PIN on click
    const pinSpans = document.querySelectorAll('.admission-pin');
    pinSpans.forEach(span => {
        span.addEventListener('click', function() {
            const revealedPin = this.nextElementSibling;
            if (revealedPin && revealedPin.classList.contains('revealed-pin')) {
                this.textContent = revealedPin.textContent;
                this.style.cursor = 'default';
                this.title = 'Admission PIN';
            }
        });
         span.style.cursor = 'pointer'; // Make it look clickable
    });

    // Resend Email functionality via AJAX or Form Submit
    const resendButtons = document.querySelectorAll('.resend-email-btn');
    const resendForm = document.getElementById('resendEmailForm');

    resendButtons.forEach(button => {
        button.addEventListener('click', function() {
            const studentId = this.dataset.id;
            const studentName = this.closest('tr').cells[2].textContent; // Get name from table row

            if (confirm(`Are you sure you want to resend the admission email (with PIN) to ${studentName}?`)) {
                 // Set the form action dynamically and submit
                 resendForm.action = `/admissions/resend-email/${studentId}/`; // Adjust URL if needed
                 resendForm.submit();

                 // Optionally disable button to prevent multiple clicks
                 this.disabled = true;
                 this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            }
        });
    });
});
</script>
{% endblock %}
