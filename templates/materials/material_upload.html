{% extends 'base/base_staff.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Upload Material | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Upload Course Material</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'materials:material_list' %}">Materials</a></li>
            <li class="breadcrumb-item active">Upload</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">New Material Details</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Upload Form -->
                    <form method="POST" action="{% url 'materials:material_upload' %}" enctype="multipart/form-data" class="row g-3 needs-validation" id="materialUploadForm" novalidate>
                        {% csrf_token %}


                        <div class="col-12">
                            <label for="{{ form.course_allocation.id_for_label }}" class="form-label">{{ form.course_allocation.label }} <span class="text-danger">*</span></label>
                             <select name="course_allocation" id="{{ form.course_allocation.id_for_label }}" class="form-select" required>
                                 <option value="">Select Course...</option>
                                 {% for alloc in allocations %}
                                     <option value="{{ alloc.id }}" {% if request.GET.course_allocation|stringformat:"s" == alloc.id|stringformat:"s" %}selected{% endif %}>
                                         {{ alloc.course.code }} - {{ alloc.course.title }} ({{ alloc.session.name }} - {{ alloc.semester.get_name_display }})
                                     </option>
                                 {% endfor %}
                             </select>
                            <div class="invalid-feedback">{{ form.course_allocation.errors|first|default:"Please select the course for this material." }}</div>
                        </div>

                        <div class="col-12">
                             <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }} <span class="text-danger">*</span></label>
                             {% render_field form.title class="form-control" required=True placeholder="e.g., Lecture Notes - Week 1" %}
                             <div class="invalid-feedback">{{ form.title.errors|first|default:"Please provide a title." }}</div>
                        </div>

                         <div class="col-12">
                             <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                             {% render_field form.description class="form-control" rows="3" placeholder="Optional: Briefly describe the material..." %}
                             <div class="invalid-feedback">{{ form.description.errors|first }}</div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.material_type.id_for_label }}" class="form-label">{{ form.material_type.label }} <span class="text-danger">*</span></label>
                            {% render_field form.material_type class="form-select" required=True id="materialTypeSelect" %}
                            <div class="invalid-feedback">{{ form.material_type.errors|first|default:"Please select the material type." }}</div>
                        </div>

                        {# Conditional Fields #}
                        <div class="col-md-6" id="fileUploadGroup" style="display: none;">
                            <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }} <span class="text-danger">*</span></label>
                            {% render_field form.file class="form-control" %}
                            <div class="invalid-feedback">{{ form.file.errors|first|default:"Please select a file to upload." }}</div>
                             <div class="progress mt-2 d-none" id="uploadProgressBarContainer">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>

                        <div class="col-md-6" id="linkGroup" style="display: none;">
                            <label for="{{ form.external_link.id_for_label }}" class="form-label">{{ form.external_link.label }} <span class="text-danger">*</span></label>
                            {% render_field form.external_link class="form-control" type="url" placeholder="https://..." %}
                            <div class="invalid-feedback">{{ form.external_link.errors|first|default:"Please enter a valid URL." }}</div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary" id="submitButton">
                                 <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true" id="submitSpinner"></span>
                                <i class="bi bi-save me-1"></i> Upload Material
                            </button>
                            <a href="{% url 'materials:material_list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form><!-- End Upload Form -->

                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  'use strict';
  // Standard Bootstrap validation setup
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      } else {
          // Add spinner on valid submission if not handled by AJAX
          // const button = document.getElementById('submitButton');
          // const spinner = document.getElementById('submitSpinner');
          // if (button && spinner) {
          //   button.disabled = true;
          //   spinner.classList.remove('d-none');
          //   button.querySelector('i').classList.add('d-none');
          // }
      }
      form.classList.add('was-validated');
    }, false);
  });

  // Show/Hide File vs Link Input based on Material Type
  const materialTypeSelect = document.getElementById('materialTypeSelect');
  const fileGroup = document.getElementById('fileUploadGroup');
  const linkGroup = document.getElementById('linkGroup');
  const fileInput = fileGroup ? fileGroup.querySelector('input[type="file"]') : null;
  const linkInput = linkGroup ? linkGroup.querySelector('input[type="url"]') : null;

  function toggleMaterialInputs() {
    if (!materialTypeSelect || !fileGroup || !linkGroup || !fileInput || !linkInput) return;

    const selectedType = materialTypeSelect.value;

    if (selectedType === 'link') {
      fileGroup.style.display = 'none';
      linkGroup.style.display = 'block';
      fileInput.required = false;
      linkInput.required = true;
    } else if (selectedType && selectedType !== '') { // Any other type requires file
      fileGroup.style.display = 'block';
      linkGroup.style.display = 'none';
      fileInput.required = true;
      linkInput.required = false;
    } else { // No type selected yet
      fileGroup.style.display = 'none';
      linkGroup.style.display = 'none';
      fileInput.required = false;
      linkInput.required = false;
    }
  }

  if (materialTypeSelect) {
    materialTypeSelect.addEventListener('change', toggleMaterialInputs);
    // Initial call to set correct state on page load (e.g., for edit form)
    toggleMaterialInputs();
  }


    // AJAX Upload with Progress (Example - adjust URL and error handling)
    const form = document.getElementById('materialUploadForm');
    const progressBarContainer = document.getElementById('uploadProgressBarContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const submitButton = document.getElementById('submitButton');
    const submitSpinner = document.getElementById('submitSpinner');

    if (form && progressBarContainer && progressBar && submitButton && fileInput) {
        form.addEventListener('submit', function(event) {
             event.preventDefault(); // Prevent default only if using AJAX
             form.classList.add('was-validated');

             if (!form.checkValidity()) {
                event.stopPropagation();
                return;
             }

             // Only handle file uploads via AJAX here, links can submit normally or use fetch
             if (fileInput.required && fileInput.files.length === 0 && materialTypeSelect.value !== 'link') {
                 // Bootstrap validation should handle this, but double check
                 return;
             }

             if (materialTypeSelect.value !== 'link' && fileInput.files.length > 0) { // Handle file upload AJAX
                submitButton.disabled = true;
                submitSpinner.classList.remove('d-none');
                submitButton.querySelector('i').classList.add('d-none');
                progressBarContainer.classList.remove('d-none');

                const formData = new FormData(form);
                const xhr = new XMLHttpRequest();

                xhr.open('POST', "{% url 'materials:upload_material_ajax' %}", true); // Use AJAX endpoint
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

                xhr.upload.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                        progressBar.setAttribute('aria-valuenow', percentComplete);
                    }
                };

                xhr.onload = function() {
                    submitButton.disabled = false;
                    submitSpinner.classList.add('d-none');
                    submitButton.querySelector('i').classList.remove('d-none');
                    progressBarContainer.classList.add('d-none');
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    progressBar.setAttribute('aria-valuenow', 0);

                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                // Redirect on success or show message
                                window.location.href = "{% url 'materials:material_list' %}"; // Redirect to list
                            } else {
                                // Display errors (e.g., append to alerts)
                                let errorMsg = response.message || 'Upload failed.';
                                if (response.errors) {
                                     errorMsg += '<br><small>' + JSON.stringify(response.errors) + '</small>';
                                }
                                showTemporaryAlert(errorMsg, 'danger');
                            }
                        } catch (e) {
                             showTemporaryAlert('Error parsing server response.', 'danger');
                             console.error("Parse Error:", e, xhr.responseText);
                        }
                    } else {
                        let errorMsg = `Upload failed with status ${xhr.status}.`;
                         try {
                             const errResponse = JSON.parse(xhr.responseText);
                             errorMsg = errResponse.message || errorMsg;
                             if (errResponse.errors) {
                                errorMsg += '<br><small>' + JSON.stringify(errResponse.errors) + '</small>';
                             }
                         } catch (e) {} // Ignore parse error on error response
                         showTemporaryAlert(errorMsg, 'danger');
                         console.error("XHR Error:", xhr.statusText);
                    }
                };

                xhr.onerror = function() {
                    submitButton.disabled = false;
                    submitSpinner.classList.add('d-none');
                    submitButton.querySelector('i').classList.remove('d-none');
                    progressBarContainer.classList.add('d-none');
                    showTemporaryAlert('Network error during upload.', 'danger');
                    console.error("Network Error");
                };

                xhr.send(formData);

             } else {
                 // Handle normal form submission for Link type or if AJAX is not desired
                 submitButton.disabled = true;
                 submitSpinner.classList.remove('d-none');
                 submitButton.querySelector('i').classList.add('d-none');
                 form.submit(); // Submit normally
             }
        });
    }

    // Helper function to show temporary alerts
    function showTemporaryAlert(message, type = 'info') {
        const alertContainer = document.querySelector('section'); // Adjust selector if needed
        if (!alertContainer) return;

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        // Prepend to the container
        alertContainer.insertBefore(alertDiv, alertContainer.firstChild);

        // Auto-dismiss after 7 seconds
        setTimeout(() => {
             const bsAlert = bootstrap.Alert.getInstance(alertDiv);
             if (bsAlert) {
                 bsAlert.close();
             } else if (alertDiv) {
                 alertDiv.remove(); // Fallback removal
             }
        }, 7000);
    }

})();
</script>
{% endblock %}
