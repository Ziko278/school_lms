{% extends 'base/base_staff.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Grade Submission | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Grade Assignment Submission</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'materials:assignment_list' %}">Assignments</a></li>
             <li class="breadcrumb-item"><a href="{% url 'materials:assignment_submissions' submission.assignment.id %}">Submissions</a></li>
            <li class="breadcrumb-item active">Grade</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Grading: {{ submission.student.user.get_full_name }} ({{ submission.student.matric_number }})</h5>
                    <h6 class="card-subtitle mb-3 text-muted">Assignment: {{ submission.assignment.title }}</h6>

                     {% include 'components/alerts.html' %}

                    <div class="row">
                         <!-- Left Column: Submission Details -->
                        <div class="col-md-7">
                             <h5>Submission Details</h5>
                             <hr>
                             <dl class="row">
                                <dt class="col-sm-4">Submitted At</dt>
                                <dd class="col-sm-8">{{ submission.submitted_at|date:"M d, Y, H:i" }}
                                    {% if submission.is_late %}
                                        <span class="badge bg-danger ms-1">LATE</span>
                                    {% else %}
                                        <span class="badge bg-success ms-1">On Time</span>
                                    {% endif %}
                                </dd>

                                <dt class="col-sm-4">Submitted File</dt>
                                <dd class="col-sm-8">
                                     <a href="{{ submission.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                         <i class="bi bi-download me-1"></i> Download/View File
                                     </a>
                                </dd>

                                {% if submission.submission_text %}
                                <dt class="col-sm-4">Text Submission</dt>
                                <dd class="col-sm-8">
                                    <div class="submission-text-box border p-2 rounded bg-light">
                                        {{ submission.submission_text|linebreaksbr }}
                                    </div>
                                </dd>
                                {% endif %}
                             </dl>

                             {# Placeholder for inline file viewer/annotator if implemented later #}
                             {# <div class="file-viewer mt-3 border p-3">
                                 <p class="text-muted text-center">Inline File Viewer (Future Feature)</p>
                             </div> #}
                        </div>

                        <!-- Right Column: Grading Form -->
                        <div class="col-md-5">
                             <h5>Grading</h5>
                             <hr>
                             <form method="POST" action="" class="row g-3 needs-validation" novalidate>
                                 {% csrf_token %}

                                 <div class="col-12">
                                     <label for="{{ form.score.id_for_label }}" class="form-label">
                                         {{ form.score.label }} <span class="text-danger">*</span>
                                         <span class="text-muted">(Out of {{ submission.assignment.total_marks|floatformat:0 }})</span>
                                     </label>
                                     {% render_field form.score class="form-control" required=True type="number" step="0.01" min="0" max=submission.assignment.total_marks placeholder="Enter score" %}
                                      <div class="invalid-feedback">{{ form.score.errors|first|default:"Please enter a valid score." }}</div>
                                     {% if form.score.errors %}
                                        {% for error in form.score.errors %}
                                        <div class="text-danger small mt-1">{{ error }}</div>
                                        {% endfor %}
                                     {% endif %}
                                 </div>

                                 <div class="col-12">
                                     <label for="{{ form.feedback.id_for_label }}" class="form-label">{{ form.feedback.label }}</label>
                                     {% render_field form.feedback class="form-control" rows="5" placeholder="Provide constructive feedback..." %}
                                     <div class="invalid-feedback">{{ form.feedback.errors|first }}</div>
                                 </div>

                                 <div class="col-12 mt-4">
                                     <button type="submit" class="btn btn-primary">
                                         <i class="bi bi-check2-square me-1"></i> Save Grade
                                     </button>
                                     <a href="{% url 'materials:assignment_submissions' submission.assignment.id %}" class="btn btn-secondary">Cancel</a>
                                 </div>
                             </form>
                        </div>
                    </div><!-- End Row -->

                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<style>
.submission-text-box {
    max-height: 200px;
    overflow-y: auto;
    font-size: 0.9em;
}
</style>
<script>
(function () {
  'use strict';
  // Standard Bootstrap validation setup
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
{% endblock %}
