{% extends 'base/base_student.html' %}
{% load static %}
{% load humanize %}
{% load tz %} {# Load timezone template tags #}

{% block title %}Assignments | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Assignments</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">Assignments</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">My Assignments</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Filter Form -->
                    <form method="get" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-5">
                            <label for="course" class="form-label form-label-sm">Filter by Course</label>
                            <select id="course" name="course" class="form-select form-select-sm">
                                <option value="">All My Registered Courses</option>
                                {% for reg in registrations %}
                                <option value="{{ reg.course.id }}" {% if reg.course.id|stringformat:"s" == selected_course %}selected{% endif %}>
                                    {{ reg.course.code }} - {{ reg.course.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                             <button type="submit" class="btn btn-secondary btn-sm w-100"><i class="bi bi-filter"></i> Filter</button>
                        </div>
                    </form>

                    <!-- Assignment Sections (Pending, Submitted, Graded) -->

                    {% regroup assignments by get_status_category as grouped_assignments %}

                    {% for group in grouped_assignments %}
                         <div class="row">
                            {% for assignment in group.list %}
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100 assignment-card {% if assignment.is_overdue and not assignment.submission %} border-danger {% endif %}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title p-0 m-0 pt-3 mb-1">{{ assignment.title }}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted small">
                                            {{ assignment.course_allocation.course.code }} | Due: {{ assignment.due_date|date:"M d, Y, H:i" }}
                                        </h6>
                                        <p class="card-text small mb-2">
                                            Marks: {{ assignment.total_marks|floatformat:0 }}
                                            {# Calculate time remaining or overdue #}
                                            {% if not assignment.submission %}
                                                {% if assignment.is_overdue %}
                                                    <span class="text-danger ms-2">({{ assignment.due_date|timesince }} overdue)</span>
                                                {% else %}
                                                    <span class="text-info ms-2">({{ assignment.due_date|timeuntil }} left)</span>
                                                {% endif %}
                                            {% endif %}
                                        </p>

                                        <div class="mt-auto pt-2 text-end">
                                             {% if assignment.submission %}
                                                {% if assignment.submission.score is not None %}
                                                    {# Graded #}
                                                    <span class="badge bg-success me-2">Graded: {{ assignment.submission.score|floatformat:1 }}/{{ assignment.total_marks|floatformat:0 }}</span>
                                                    <a href="{% url 'materials:student_assignment_view_feedback' assignment.submission.id %}" class="btn btn-info btn-sm">
                                                        <i class="bi bi-eye me-1"></i> View Feedback
                                                    </a>
                                                {% else %}
                                                    {# Submitted, Pending Grade #}
                                                    <span class="badge bg-secondary me-2">Submitted</span>
                                                    <a href="{% url 'materials:student_assignment_view_feedback' assignment.submission.id %}" class="btn btn-outline-secondary btn-sm">
                                                         View Submission
                                                    </a>
                                                {% endif %}
                                             {% else %}
                                                {# Not Submitted #}
                                                {% if assignment.is_overdue %}
                                                     <span class="badge bg-danger me-2">Overdue</span>
                                                     <a href="{% url 'materials:student_assignment_submit' assignment.id %}" class="btn btn-warning btn-sm">
                                                        <i class="bi bi-upload me-1"></i> Submit Late
                                                     </a>
                                                {% else %}
                                                     <a href="{% url 'materials:student_assignment_submit' assignment.id %}" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-upload me-1"></i> Submit Now
                                                     </a>
                                                {% endif %}
                                             {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                         </div>
                    {% empty %}
                        <div class="col-12">
                            <div class="alert alert-light text-center" role="alert">
                                No assignments found for your registered courses{% if selected_course %} matching the selected filter{% endif %}.
                            </div>
                        </div>
                    {% endfor %}

                    <!-- End Assignment Sections -->

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<style>
.assignment-card .card-title {
    font-size: 1.1rem;
    line-height: 1.3;
}
.assignment-card.border-danger {
    border-left-width: 3px !important;
}
</style>
{# Add JS for countdown timers if desired #}
<script>
// Optional: Add countdown timer logic here if needed
</script>
{% endblock %}
