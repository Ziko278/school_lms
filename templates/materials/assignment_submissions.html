{% extends 'base/base_staff.html' %}
{% load static %}
{% load humanize %}

{% block title %}Submissions: {{ assignment.title }} | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Assignment Submissions</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'materials:assignment_list' %}">Assignments</a></li>
            <li class="breadcrumb-item active">Submissions</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <!-- Assignment Details -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                     <h5 class="card-title">{{ assignment.title }}</h5>
                     <h6 class="card-subtitle mb-2 text-muted">{{ assignment.course_allocation.course.code }} - {{ assignment.course_allocation.course.title }}</h6>
                     <p><strong>Due:</strong> {{ assignment.due_date|date:"M d, Y, H:i" }} | <strong>Marks:</strong> {{ assignment.total_marks|floatformat:0 }}</p>
                     {% if assignment.file %}
                     <p><a href="{{ assignment.file.url }}" target="_blank"><i class="bi bi-paperclip"></i> View Assignment File</a></p>
                     {% endif %}
                     <hr>
                     <div>{{ assignment.description|safe }}</div>
                </div>
            </div>
        </div>

         <!-- Statistics -->
         <div class="col-lg-12">
             <div class="row">
                 <div class="col-md-3">
                     <div class="card info-card">
                         <div class="card-body">
                             <h5 class="card-title">Total Students</h5>
                             <div class="d-flex align-items-center">
                                 <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-secondary-light">
                                     <i class="bi bi-people text-secondary"></i>
                                 </div>
                                 <div class="ps-3"><h6>{{ total_students }}</h6></div>
                             </div>
                         </div>
                     </div>
                 </div>
                  <div class="col-md-3">
                     <div class="card info-card">
                         <div class="card-body">
                             <h5 class="card-title">Submitted</h5>
                             <div class="d-flex align-items-center">
                                 <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-primary-light">
                                     <i class="bi bi-upload text-primary"></i>
                                 </div>
                                 <div class="ps-3"><h6>{{ submitted_count }}</h6></div>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="card info-card">
                         <div class="card-body">
                             <h5 class="card-title">Graded</h5>
                             <div class="d-flex align-items-center">
                                 <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-success-light">
                                     <i class="bi bi-check2-circle text-success"></i>
                                 </div>
                                 <div class="ps-3"><h6>{{ graded_count }}</h6></div>
                             </div>
                         </div>
                     </div>
                 </div>
                  <div class="col-md-3">
                     <div class="card info-card">
                         <div class="card-body">
                             <h5 class="card-title">Pending Grading</h5>
                             <div class="d-flex align-items-center">
                                 <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-warning-light">
                                     <i class="bi bi-hourglass-split text-warning"></i>
                                 </div>
                                 <div class="ps-3"><h6>{{ pending_count }}</h6></div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div><!-- End Statistics -->

        <!-- Submissions Table -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                     <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Student Submissions</h5>
                        {# Add Filter Dropdown if needed #}
                        {# <div class="dropdown"> ... </div> #}
                    </div>

                    {% include 'components/alerts.html' %}

                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable-custom">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Matric No.</th>
                                    <th scope="col">Student Name</th>
                                    <th scope="col">Submitted At</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Score</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for submission in submissions %}
                                <tr>
                                    <th scope="row">{{ forloop.counter }}</th>
                                    <td>{{ submission.student.matric_number }}</td>
                                    <td>{{ submission.student.user.get_full_name }}</td>
                                    <td>{{ submission.submitted_at|date:"M d, Y, H:i" }}</td>
                                    <td>
                                        {% if submission.is_late %}
                                            <span class="badge bg-danger">Late</span>
                                        {% else %}
                                             <span class="badge bg-success">On Time</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if submission.score is not None %}
                                            {{ submission.score|floatformat:1 }}/{{ assignment.total_marks|floatformat:0 }}
                                        {% else %}
                                            <span class="text-muted fst-italic">Not Graded</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if submission.score is not None %}
                                            {# View/Edit Grade #}
                                             <a href="{% url 'materials:assignment_grading' submission.id %}" class="btn btn-warning btn-sm" title="Edit Grade"><i class="bi bi-pencil-square"></i></a>
                                             <a href="{{ submission.file.url }}" target="_blank" class="btn btn-secondary btn-sm" title="View Submission"><i class="bi bi-eye"></i></a>
                                        {% else %}
                                            {# Grade Now #}
                                             <a href="{% url 'materials:assignment_grading' submission.id %}" class="btn btn-primary btn-sm" title="Grade Now"><i class="bi bi-check2-square"></i> Grade</a>
                                             <a href="{{ submission.file.url }}" target="_blank" class="btn btn-secondary btn-sm" title="View Submission"><i class="bi bi-eye"></i></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No submissions received yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Submissions Table -->

                </div>
            </div>
        </div><!-- End Submissions Table -->
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const customTable = document.querySelector('.datatable-custom');
        if (customTable) {
            new simpleDatatables.DataTable(customTable, {
                searchable: true, // Allow searching students
                // paging: false // Disable if using Django pagination component
            });
        }
    });
</script>
{% endblock %}
