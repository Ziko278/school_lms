{% extends 'base/base_admin.html' %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Payments | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Payments Management</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section dashboard">
    <div class="row">
        <!-- Statistics Cards -->
        <div class="col-lg-12">
            <div class="row">
                 <div class="col-md-3">
                    <div class="card info-card revenue-card">
                        <div class="card-body">
                            <h5 class="card-title">Total Revenue</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>₦{{ total_revenue|intcomma }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-md-3">
                    <div class="card info-card success-card"> {# Custom class needed or use bg-success #}
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start"><h6>Filter</h6></li>
                                <li><a class="dropdown-item" href="?status=success">View Successful</a></li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Successful</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-success-light">
                                    <i class="bi bi-check2-circle text-success"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ successful_count }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-md-3">
                     <div class="card info-card warning-card"> {# Custom class needed or use bg-warning #}
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start"><h6>Filter</h6></li>
                                <li><a class="dropdown-item" href="?status=pending">View Pending</a></li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Pending</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-warning-light">
                                    <i class="bi bi-hourglass-split text-warning"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ pending_count }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-md-3">
                     <div class="card info-card danger-card"> {# Custom class needed or use bg-danger #}
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start"><h6>Filter</h6></li>
                                <li><a class="dropdown-item" href="?status=failed">View Failed</a></li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Failed</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-danger-light">
                                    <i class="bi bi-x-octagon text-danger"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ failed_count }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- End Statistics Cards -->

        <!-- Payment List Table -->
        <div class="col-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                         <h5 class="card-title">All Payments</h5>
                         <a href="{% url 'admin_site:payment_report' %}" class="btn btn-sm btn-outline-secondary">
                             <i class="bi bi-file-earmark-bar-graph"></i> View Report
                         </a>
                    </div>


                    {% include 'components/alerts.html' %}

                     <!-- Filter & Search Form -->
                    <form method="get" class="row g-2 mb-4 align-items-end">
                         <div class="col-md-2">
                            <label for="{{ form.status.id_for_label }}" class="form-label form-label-sm">Status</label>
                            {% render_field form.status class="form-select form-select-sm" %}
                        </div>
                        <div class="col-md-2">
                            <label for="{{ form.payment_type.id_for_label }}" class="form-label form-label-sm">Payment Type</label>
                            {% render_field form.payment_type class="form-select form-select-sm" %}
                        </div>
                        <div class="col-md-2">
                            <label for="{{ form.date_from.id_for_label }}" class="form-label form-label-sm">Date From</label>
                            {% render_field form.date_from class="form-control form-control-sm" type="date" %}
                        </div>
                         <div class="col-md-2">
                            <label for="{{ form.date_to.id_for_label }}" class="form-label form-label-sm">Date To</label>
                            {% render_field form.date_to class="form-control form-control-sm" type="date" %}
                        </div>
                        <div class="col-md-3">
                             <label for="search" class="form-label form-label-sm visually-hidden">Search Reference</label>
                            <input type="text" id="search" class="form-control form-control-sm" name="search" placeholder="Search by Reference..." value="{{ search_query|default:'' }}">
                        </div>
                        <div class="col-md-1">
                             <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search"></i></button>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Reference</th>
                                    <th scope="col">Student / Name</th>
                                    <th scope="col">Amount (₦)</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">Method</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments_page %}
                                <tr>
                                    <th scope="row">{{ forloop.counter0|add:payments_page.start_index }}</th>
                                    <td><code>{{ payment.reference }}</code></td>
                                    <td>
                                        {% if payment.student %}
                                            <a href="{% url 'accounts:student_detail' payment.student.id %}">{{ payment.student.user.get_full_name }}</a>
                                            <small class="d-block text-muted">{{ payment.student.matric_number }}</small>
                                        {% elif payment.admitted_student %}
                                             <a href="{% url 'admissions:admitted_detail' payment.admitted_student.id %}">{{ payment.admitted_student.first_name }} {{ payment.admitted_student.last_name }}</a>
                                            <small class="d-block text-muted">{{ payment.admitted_student.jamb_registration_number }}</small>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ payment.amount|intcomma }}</td>
                                    <td>{{ payment.get_payment_type_display }}</td>
                                    <td>
                                        <span class="badge
                                            {% if payment.status == 'pending' %} bg-warning text-dark
                                            {% elif payment.status == 'success' %} bg-success
                                            {% elif payment.status == 'failed' %} bg-danger
                                            {% else %} bg-secondary {% endif %}">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ payment.payment_date|date:"Y-m-d H:i"|default:"-" }}</td>
                                    <td>{{ payment.payment_method }}</td>
                                    <td>
                                        <a href="{% url 'payments:payment_detail' payment.id %}" class="btn btn-info btn-sm" title="View Details"><i class="bi bi-eye"></i></a>
                                        {% if payment.status == 'success' %}
                                         <a href="{% url 'payments:payment_receipt' payment.id %}" target="_blank" class="btn btn-secondary btn-sm" title="Download Receipt"><i class="bi bi-receipt"></i></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No payments found matching your criteria.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div><!-- End Table -->

                    {% include 'components/pagination.html' with page_obj=payments_page %}

                </div>

            </div>
        </div><!-- End Payment List Table -->
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{# Add JS for date pickers if needed #}
{% endblock %}
