{% extends 'base/base_admin.html' %} {# Student uses admin base #}
{% load static %}

{% block title %}Request Password Change | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Request Password Change</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-6">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Submit Password Change Request</h5>

                     {% include 'components/alerts.html' %} {# Display success/error messages #}

                    <div class="alert alert-info" role="alert">
                      <h4 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i> How it works</h4>
                      <p>If you've forgotten your password or need it reset, please provide a reason below. Your request will be reviewed by the administrator.</p>
                      <hr>
                      <p class="mb-0">If approved, a new temporary password will be sent to your registered email address (<span class="fw-bold">{{ request.user.email }}</span>). You will be required to change this temporary password upon your next login.</p>
                    </div>

                    {# Check if user has a pending request #}
                    {% with pending_request=request.user.password_requests.first %}
                        {% if pending_request and pending_request.status == 'pending' %}
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-hourglass-split me-2"></i> You already have a <span class="fw-bold">pending</span> password change request submitted on {{ pending_request.requested_at|date:"M d, Y" }}. Please wait for it to be processed.
                            </div>
                        {% else %}
                             <!-- Password Request Form -->
                            <form method="POST" action="{% url 'accounts:request_password_change' %}">
                                {% csrf_token %}

                                <div class="row mb-3">
                                    <label for="{{ form.reason.id_for_label }}" class="col-12 col-form-label">{{ form.reason.label }}</label>
                                    <div class="col-12">
                                        {{ form.reason }}
                                        {% if form.reason.errors %}
                                            <div class="text-danger small mt-1">{{ form.reason.errors|first }}</div>
                                        {% else %}
                                            <div class="form-text small">
                                                 Please briefly explain why you need your password changed (e.g., "Forgot password", "Account potentially compromised").
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if form.non_field_errors %}
                                    <div class="row mb-3">
                                        <div class="col-12 text-danger small">
                                            {% for error in form.non_field_errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">Submit Request</button>
                                    <a href="{% url 'accounts:dashboard' %}" class="btn btn-secondary">Cancel</a>
                                </div>
                            </form><!-- End Password Request Form -->
                        {% endif %}
                    {% endwith %}

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}
