{% extends 'base/base_admin.html' %}
{% load static %}

{% block title %}Password Change Requests | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Password Change Requests</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                     <h5 class="card-title">Manage Student Password Requests</h5>

                    {% include 'components/alerts.html' %}

                    <!-- Filters -->
                    <form method="get" class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                             <label for="status" class="form-label form-label-sm">Status</label>
                             <select id="status" name="status" class="form-select form-select-sm">
                                <option value="">All (Default: Pending)</option>
                                {% for value, display in status_choices %}
                                <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-6">
                            {# Optional Search #}
                            {# <label for="search" class="form-label form-label-sm">Search (Student)</label>
                            <input type="text" id="search" class="form-control form-control-sm" name="search" placeholder="Matric No or Name..."> #}
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-filter me-1"></i> Filter Requests</button>
                        </div>
                    </form>

                    <!-- Requests Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable-custom">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Student</th>
                                    <th scope="col">Matric No</th>
                                    <th scope="col">Reason</th>
                                    <th scope="col">Requested At</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Processed By</th>
                                    <th scope="col">Processed At</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in requests_page %}
                                <tr>
                                    <th scope="row">{{ forloop.counter0|add:requests_page.start_index }}</th>
                                    <td>{{ req.user.get_full_name|default:"N/A" }}</td>
                                     <td>{{ req.user.student.matric_number|default:"N/A" }}</td>
                                    <td>{{ req.reason|truncatechars:50 }}</td>
                                    <td>{{ req.requested_at|date:"M d, Y P" }}</td>
                                     <td>
                                        <span class="badge {% if req.status == 'approved' %}bg-success{% elif req.status == 'pending'%}bg-warning text-dark{% elif req.status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}">{{ req.get_status_display }}</span>
                                     </td>
                                     <td>{{ req.processed_by.get_full_name|default:"N/A" }}</td>
                                     <td>{{ req.processed_at|date:"M d, Y P"|default:"N/A" }}</td>
                                    <td>
                                        {% if req.status == 'pending' %}
                                            <button type="button" class="btn btn-success btn-sm" title="Approve Request" data-bs-toggle="modal" data-bs-target="#approveModal{{ req.id }}">
                                                <i class="bi bi-check-lg"></i> Approve
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" title="Reject Request" data-bs-toggle="modal" data-bs-target="#rejectModal{{ req.id }}">
                                                <i class="bi bi-x-lg"></i> Reject
                                            </button>
                                        {% else %}
                                            <span class="text-muted small">Processed</span>
                                        {% endif %}
                                    </td>
                                </tr>

                                 <!-- Approve Confirmation Modal -->
                                <div class="modal fade" id="approveModal{{ req.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                            <h5 class="modal-title">Confirm Approval</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                            Approve the password reset request for <strong>{{ req.user.get_full_name }}</strong>?<br>
                                            A new temporary password will be generated and sent to <strong class="text-primary">{{ req.user.email }}</strong>.
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form action="{% url 'accounts:password_request_approve' req.id %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success">Approve Request</button>
                                            </form>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- End Modal -->

                                 <!-- Reject Confirmation Modal -->
                                <div class="modal fade" id="rejectModal{{ req.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                            <h5 class="modal-title">Confirm Rejection</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{% url 'accounts:password_request_reject' req.id %}" method="post">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    Reject the password reset request for <strong>{{ req.user.get_full_name }}</strong>?<br><br>
                                                     <label for="rejection_reason_{{ req.id }}" class="form-label">Reason for Rejection (Optional, added to remarks):</label>
                                                     <textarea class="form-control form-control-sm" id="rejection_reason_{{ req.id }}" name="rejection_reason" rows="2"></textarea>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-danger">Reject Request</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div><!-- End Modal -->


                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No password change requests found matching your criteria.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Requests Table -->

                     <!-- Pagination -->
                     {% include 'components/pagination.html' with page_obj=requests_page %}

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize simple-datatables if needed
    // new simpleDatatables.DataTable('.datatable-custom');
</script>
{% endblock %}
