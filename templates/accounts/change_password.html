{% extends 'base/base_admin.html' %} {# Assume all users use admin base for changing password #}
{% load static %}

{% block title %}Change Password | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>Change Password</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-6">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Update Your Password</h5>
                    <p class="small text-muted mb-3">Ensure your account is using a long, random password to stay secure.</p>

                    {% include 'components/alerts.html' %} {# Display success/error messages #}

                    <!-- Change Password Form -->
                    <form method="POST" action="{% url 'accounts:change_password' %}">
                        {% csrf_token %}

                        <div class="row mb-3">
                            <label for="{{ form.old_password.id_for_label }}" class="col-md-4 col-lg-4 col-form-label">Current Password</label>
                            <div class="col-md-8 col-lg-8">
                                {{ form.old_password }}
                                {% if form.old_password.errors %}
                                    <div class="text-danger small mt-1">{{ form.old_password.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="{{ form.new_password1.id_for_label }}" class="col-md-4 col-lg-4 col-form-label">New Password</label>
                            <div class="col-md-8 col-lg-8">
                                {{ form.new_password1 }}
                                {% if form.new_password1.errors %}
                                    <div class="text-danger small mt-1">{{ form.new_password1.errors|first }}</div>
                                {% else %}
                                    <div class="form-text small">
                                         {{ form.new_password1.help_text|safe }}
                                    </div>
                                {% endif %}
                                {# Simple Password Strength Indicator (Optional) #}
                                <div class="progress mt-2" style="height: 5px;">
                                    <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div id="passwordStrengthText" class="small mt-1"></div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="{{ form.new_password2.id_for_label }}" class="col-md-4 col-lg-4 col-form-label">Confirm New Password</label>
                            <div class="col-md-8 col-lg-8">
                                {{ form.new_password2 }}
                                {% if form.new_password2.errors %}
                                    <div class="text-danger small mt-1">{{ form.new_password2.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        {% if form.non_field_errors %}
                            <div class="row mb-3">
                                <div class="col-md-8 col-lg-8 offset-md-4 offset-lg-4 text-danger small">
                                    {% for error in form.non_field_errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Change Password</button>
                            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form><!-- End Change Password Form -->

                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Simple password strength checker (adjust criteria as needed)
    const passwordInput = document.getElementById("{{ form.new_password1.id_for_label }}");
    const strengthBar = document.getElementById("passwordStrengthBar");
    const strengthText = document.getElementById("passwordStrengthText");

    passwordInput.addEventListener('input', function() {
        const val = passwordInput.value;
        let strength = 0;
        let text = "";
        let barClass = "";

        if (val.length === 0) {
           strength = 0;
           text = "";
           barClass = "";
        } else {
            if (val.length >= 8) strength++;
            if (val.match(/[a-z]/)) strength++;
            if (val.match(/[A-Z]/)) strength++;
            if (val.match(/[0-9]/)) strength++;
            if (val.match(/[^a-zA-Z0-9]/)) strength++; // Special character

            switch (strength) {
                case 1:
                case 2:
                    text = "Weak"; barClass = "bg-danger"; break;
                case 3:
                    text = "Medium"; barClass = "bg-warning"; break;
                case 4:
                case 5:
                    text = "Strong"; barClass = "bg-success"; break;
                default:
                    text = "Very Weak"; barClass = "bg-danger"; strength = 1; // Ensure bar shows a little
            }
        }

        const percentage = (strength / 5) * 100;
        strengthBar.style.width = percentage + '%';
        strengthBar.className = "progress-bar " + barClass;
        strengthBar.setAttribute('aria-valuenow', percentage);
        strengthText.textContent = text;
        strengthText.className = "small mt-1 " + (barClass === 'bg-danger' ? 'text-danger' : (barClass === 'bg-warning' ? 'text-warning' : 'text-success'));

        if(val.length === 0) strengthText.textContent = "";

    });
</script>
{% endblock %}
