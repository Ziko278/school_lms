{% extends 'base/base_admin.html' %}
{% load static %}

{% block title %}System Settings | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>System Settings</h1>
    {% include 'components/breadcrumb.html' %}
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            {% include 'components/alerts.html' %}

             <!-- Settings Tabs -->
            <ul class="nav nav-tabs nav-tabs-bordered d-flex" id="settingsTab" role="tablist">
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100 active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-settings" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration-settings" type="button" role="tab" aria-controls="registration" aria-selected="false">Registration</button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment-settings" type="button" role="tab" aria-controls="payment" aria-selected="false">Payment</button>
                </li>
                 <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="idformat-tab" data-bs-toggle="tab" data-bs-target="#idformat-settings" type="button" role="tab" aria-controls="idformat" aria-selected="false">ID Formats</button>
                </li>
            </ul>
             <!-- End Settings Tabs -->

             <!-- Form Start -->
            <form method="POST" action="{% url 'admin_site:system_settings' %}" class="needs-validation" novalidate>
                 {% csrf_token %}

                <div class="tab-content pt-2" id="settingsTabContent">

                    <!-- General Settings Tab -->
                    <div class="tab-pane fade show active" id="general-settings" role="tabpanel" aria-labelledby="general-tab">
                         <div class="card">
                            <div class="card-body pt-3">
                                 <h5 class="card-title">General System Configuration</h5>
                                  <div class="row g-3">
                                     <div class="col-md-6">
                                        <label for="{{ form.current_session.id_for_label }}" class="form-label">{{ form.current_session.label }}</label>
                                        {{ form.current_session }}
                                        <div class="invalid-feedback">{{ form.current_session.errors|first }}</div>
                                        <button type="button" id="setActiveSessionBtn" class="btn btn-sm btn-outline-primary mt-1" disabled>Set as Active</button>
                                        <span id="sessionStatus" class="ms-2 small"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.current_semester.id_for_label }}" class="form-label">{{ form.current_semester.label }}</label>
                                        {{ form.current_semester }}
                                        <div class="invalid-feedback">{{ form.current_semester.errors|first }}</div>
                                        <button type="button" id="setActiveSemesterBtn" class="btn btn-sm btn-outline-primary mt-1" disabled>Set as Active</button>
                                         <span id="semesterStatus" class="ms-2 small"></span>
                                         <div class="form-text small">Ensure the selected semester belongs to the active session.</div>
                                    </div>
                                      {# Add other general settings if any #}
                                      <div class="col-12 mt-4 text-end">
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save General Settings</button>
                                     </div>
                                  </div>
                            </div>
                         </div>
                    </div>
                    <!-- End General Settings Tab -->

                    <!-- Registration Settings Tab -->
                    <div class="tab-pane fade" id="registration-settings" role="tabpanel" aria-labelledby="registration-tab">
                        <div class="card">
                            <div class="card-body pt-3">
                                 <h5 class="card-title">Registration Controls</h5>
                                 <div class="row g-3">
                                      <div class="col-md-6 d-flex align-items-center">
                                        <div class="form-check form-switch form-check-lg">
                                            {{ form.allow_student_registration }}
                                            <label class="form-check-label" for="{{ form.allow_student_registration.id_for_label }}">{{ form.allow_student_registration.label }}</label>
                                             <div class="form-text small">{{ form.allow_student_registration.help_text }}</div>
                                        </div>
                                         <span id="studentRegStatus" class="ms-3 small"></span>
                                     </div>
                                      <div class="col-md-6 d-flex align-items-center">
                                        <div class="form-check form-switch form-check-lg">
                                            {{ form.allow_course_registration }}
                                            <label class="form-check-label" for="{{ form.allow_course_registration.id_for_label }}">{{ form.allow_course_registration.label }}</label>
                                             <div class="form-text small">{{ form.allow_course_registration.help_text }}</div>
                                        </div>
                                         <span id="courseRegStatus" class="ms-3 small"></span>
                                     </div>
                                      <div class="col-md-6 d-flex align-items-center">
                                         <div class="form-check form-switch form-check-lg">
                                            {{ form.jamb_verification_enabled }}
                                            <label class="form-check-label" for="{{ form.jamb_verification_enabled.id_for_label }}">{{ form.jamb_verification_enabled.label }}</label>
                                        </div>
                                     </div>
                                      <div class="col-12 mt-4 text-end">
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save Registration Settings</button>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Registration Settings Tab -->

                    <!-- Payment Settings Tab -->
                    <div class="tab-pane fade" id="payment-settings" role="tabpanel" aria-labelledby="payment-tab">
                         <div class="card">
                            <div class="card-body pt-3">
                                 <h5 class="card-title">Payment Configuration</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.registration_fee.id_for_label }}" class="form-label">{{ form.registration_fee.label }} (â‚¦)</label>
                                        {{ form.registration_fee }}
                                        <div class="invalid-feedback">{{ form.registration_fee.errors|first }}</div>
                                    </div>
                                    <div class="col-md-6"></div> {# Spacer #}

                                    <div class="col-md-12">
                                        <label for="{{ form.paystack_public_key.id_for_label }}" class="form-label">{{ form.paystack_public_key.label }}</label>
                                        {{ form.paystack_public_key }}
                                        <div class="invalid-feedback">{{ form.paystack_public_key.errors|first }}</div>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="{{ form.paystack_secret_key.id_for_label }}" class="form-label">{{ form.paystack_secret_key.label }}</label>
                                        {{ form.paystack_secret_key }}
                                        <div class="invalid-feedback">{{ form.paystack_secret_key.errors|first }}</div>
                                         <div class="form-text small">Enter your Paystack API keys to enable online payments.</div>
                                    </div>
                                     <div class="col-12 mt-4 text-end">
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save Payment Settings</button>
                                     </div>
                                </div>
                            </div>
                         </div>
                    </div>
                    <!-- End Payment Settings Tab -->

                     <!-- ID Formats Tab -->
                    <div class="tab-pane fade" id="idformat-settings" role="tabpanel" aria-labelledby="idformat-tab">
                         <div class="card">
                            <div class="card-body pt-3">
                                 <h5 class="card-title">ID Number Formats</h5>
                                 <div class="alert alert-info small" role="alert">
                                    Use the following placeholders:
                                    <ul>
                                        <li><code>{YEAR}</code>: Current year (e.g., 2024)</li>
                                        <li><code>{SESSION_SHORT}</code>: Short session year (e.g., 24 for 2024/2025)</li>
                                        <li><code>{DEPT}</code>: Department code (e.g., CSC)</li>
                                        <li><code>{SERIAL}</code>: Auto-incrementing serial number (e.g., 001, 002)</li>
                                    </ul>
                                 </div>
                                <div class="row g-3">
                                     <div class="col-md-12">
                                        <label for="{{ form.matric_number_format.id_for_label }}" class="form-label">{{ form.matric_number_format.label }}</label>
                                        {{ form.matric_number_format }}
                                        <div class="invalid-feedback">{{ form.matric_number_format.errors|first }}</div>
                                         <div class="form-text small">{{ form.matric_number_format.help_text }} Example: COE/{SESSION_SHORT}/{DEPT}/{SERIAL} -> COE/24/CSC/001</div>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="{{ form.staff_id_format.id_for_label }}" class="form-label">{{ form.staff_id_format.label }}</label>
                                        {{ form.staff_id_format }}
                                        <div class="invalid-feedback">{{ form.staff_id_format.errors|first }}</div>
                                         <div class="form-text small">{{ form.staff_id_format.help_text }} Example: STAFF/{YEAR}/{SERIAL} -> STAFF/2024/001</div>
                                    </div>
                                     <div class="col-12 mt-4 text-end">
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save ID Formats</button>
                                     </div>
                                </div>
                            </div>
                         </div>
                    </div>
                    <!-- End ID Formats Tab -->

                </div><!-- End Tab Content -->
            </form> <!-- End Form -->


        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentRegSwitch = document.getElementById("{{ form.allow_student_registration.id_for_label }}");
    const courseRegSwitch = document.getElementById("{{ form.allow_course_registration.id_for_label }}");
    const studentRegStatus = document.getElementById("studentRegStatus");
    const courseRegStatus = document.getElementById("courseRegStatus");

    const sessionSelect = document.getElementById("{{ form.current_session.id_for_label }}");
    const semesterSelect = document.getElementById("{{ form.current_semester.id_for_label }}");
    const setActiveSessionBtn = document.getElementById("setActiveSessionBtn");
    const setActiveSemesterBtn = document.getElementById("setActiveSemesterBtn");
    const sessionStatus = document.getElementById("sessionStatus");
    const semesterStatus = document.getElementById("semesterStatus");
    const currentSessionId = "{{ settings.current_session.id|default:'' }}";
    const currentSemesterId = "{{ settings.current_semester.id|default:'' }}";

    // --- Toggle Switches ---
    function setupToggleSwitch(switchElement, statusElement, type) {
        switchElement.addEventListener('change', function() {
            const isChecked = this.checked;
            statusElement.textContent = 'Saving...';
            statusElement.className = 'ms-3 small text-muted';

            const formData = new FormData();
            formData.append('type', type);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch("{% url 'admin_site:toggle_registration_ajax' %}", {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusElement.textContent = data.message;
                    statusElement.className = data.new_status ? 'ms-3 small text-success' : 'ms-3 small text-danger';
                     // Update switch state visually if it didn't update automatically
                     switchElement.checked = data.new_status;
                } else {
                    statusElement.textContent = 'Error: ' + data.message;
                    statusElement.className = 'ms-3 small text-danger';
                    // Revert switch state
                    switchElement.checked = !isChecked;
                }
            })
            .catch(error => {
                console.error('Error toggling registration:', error);
                statusElement.textContent = 'Error saving.';
                statusElement.className = 'ms-3 small text-danger';
                 // Revert switch state
                 switchElement.checked = !isChecked;
            });
        });
    }

    setupToggleSwitch(studentRegSwitch, studentRegStatus, 'student');
    setupToggleSwitch(courseRegSwitch, courseRegStatus, 'course');


    // --- Active Session/Semester ---
    sessionSelect.addEventListener('change', function() {
        setActiveSessionBtn.disabled = (this.value === currentSessionId || this.value === "");
    });
    semesterSelect.addEventListener('change', function() {
         setActiveSemesterBtn.disabled = (this.value === currentSemesterId || this.value === "");
         // Also load semesters based on session selection if needed
         loadSemestersForSession(sessionSelect.value); // Implement this if needed
    });

    setActiveSessionBtn.addEventListener('click', function() {
        const sessionId = sessionSelect.value;
        if (!sessionId) return;

        sessionStatus.textContent = 'Setting...';
        sessionStatus.className = 'ms-2 small text-muted';
        this.disabled = true;

        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'admin_site:set_active_session_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sessionStatus.textContent = data.message;
                sessionStatus.className = 'ms-2 small text-success';
                // Update currentSessionId and reload or update UI
                window.location.reload(); // Simple reload for now
            } else {
                sessionStatus.textContent = 'Error: ' + data.message;
                sessionStatus.className = 'ms-2 small text-danger';
                 setActiveSessionBtn.disabled = (sessionSelect.value === currentSessionId || sessionSelect.value === ""); // Re-enable if not current
            }
        })
        .catch(error => {
            console.error('Error setting session:', error);
            sessionStatus.textContent = 'Error setting session.';
            sessionStatus.className = 'ms-2 small text-danger';
            setActiveSessionBtn.disabled = (sessionSelect.value === currentSessionId || sessionSelect.value === ""); // Re-enable if not current
        });
    });

     setActiveSemesterBtn.addEventListener('click', function() {
        const semesterId = semesterSelect.value;
        if (!semesterId) return;

        semesterStatus.textContent = 'Setting...';
        semesterStatus.className = 'ms-2 small text-muted';
        this.disabled = true;

        const formData = new FormData();
        formData.append('semester_id', semesterId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

         fetch("{% url 'admin_site:set_active_semester_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                semesterStatus.textContent = data.message;
                semesterStatus.className = 'ms-2 small text-success';
                // Update currentSemesterId and reload or update UI
                 window.location.reload(); // Simple reload
            } else {
                 semesterStatus.textContent = 'Error: ' + data.message;
                 semesterStatus.className = 'ms-2 small text-danger';
                 setActiveSemesterBtn.disabled = (semesterSelect.value === currentSemesterId || semesterSelect.value === "");
            }
        })
        .catch(error => {
            console.error('Error setting semester:', error);
            semesterStatus.textContent = 'Error setting semester.';
            semesterStatus.className = 'ms-2 small text-danger';
             setActiveSemesterBtn.disabled = (semesterSelect.value === currentSemesterId || semesterSelect.value === "");
        });
    });

    // Initial button state
    setActiveSessionBtn.disabled = (sessionSelect.value === currentSessionId || sessionSelect.value === "");
    setActiveSemesterBtn.disabled = (semesterSelect.value === currentSemesterId || semesterSelect.value === "");

    // Function to load semesters (if needed for dependency)
    function loadSemestersForSession(sessionId) {
        if (!sessionId) {
            // Clear or disable semester dropdown
            semesterSelect.innerHTML = '<option value="">Select Session First</option>';
            return;
        }
        // Fetch semesters for session ID via AJAX
        fetch(`{% url 'academics:get_semesters_ajax' %}?session_id=${sessionId}`)
            .then(response => response.json())
            .then(data => {
                 semesterSelect.innerHTML = '<option value="">Select Semester</option>';
                 data.semesters.forEach(sem => {
                    const option = new Option(`${sem.name === 'first' ? 'First' : 'Second'} Semester ${sem.is_active ? '(Active)' : ''}`, sem.id);
                     if (sem.id == currentSemesterId) { // Check against original current ID
                         option.selected = true;
                     }
                    semesterSelect.appendChild(option);
                 });
                 // Re-evaluate button disabled state after loading
                 setActiveSemesterBtn.disabled = (semesterSelect.value === currentSemesterId || semesterSelect.value === "");
            })
            .catch(error => console.error('Error loading semesters:', error));
    }

     // Trigger semester load if session is pre-selected
     if (sessionSelect.value) {
         loadSemestersForSession(sessionSelect.value);
     }


     // Example Bootstrap validation activation
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })();
});
</script>
{% endblock %}
