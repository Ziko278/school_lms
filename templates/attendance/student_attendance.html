{% extends 'base/base_student.html' %}
{% load static %}
{% load humanize %}
{% load attendance_tags %}

{% block title %}My Attendance | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>My Attendance</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">Attendance</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <!-- Filter and Summary Cards -->
        <div class="col-lg-12">
             <div class="card">
                 <div class="card-body">
                    <h5 class="card-title pb-0">Attendance Overview</h5>
                     <!-- Filter Form -->
                    <form method="get" class="row g-3 mb-3 align-items-end">
                        <div class="col-md-5">
                            <label for="course" class="form-label form-label-sm">Filter by Course</label>
                            <select id="course" name="course" class="form-select form-select-sm">
                                <option value="">All My Registered Courses</option>
                                {% for reg in registrations %}
                                <option value="{{ reg.course.id }}" {% if reg.course.id|stringformat:"s" == selected_course %}selected{% endif %}>
                                    {{ reg.course.code }} - {{ reg.course.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                             <button type="submit" class="btn btn-secondary btn-sm w-100"><i class="bi bi-filter"></i> Filter</button>
                        </div>
                    </form>

                     <!-- Summary Cards for Filtered Courses -->
                     <div class="row">
                         {% if selected_course %}
                            {% with course_id_int=selected_course|add:0 %} {# Convert to int for dict lookup #}
                             {% if course_id_int in course_stats %}
                                {% with stats=course_stats|get_item:course_id_int %}
                                    {% for reg in registrations %} {# Find the selected course title #}
                                        {% if reg.course.id == course_id_int %}
                                            <h6 class="text-center text-muted mb-3">{{ reg.course.code }} - {{ reg.course.title }}</h6>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="col-md-3 col-6">
                                        <div class="text-center">
                                            <h4 class="text-secondary">{{ stats.total }}</h4>
                                            <span class="text-muted small">Classes</span>
                                        </div>
                                    </div>
                                     <div class="col-md-3 col-6">
                                        <div class="text-center">
                                            <h4 class="text-success">{{ stats.present }}</h4>
                                            <span class="text-muted small">Present</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="text-center">
                                            <h4 class="text-danger">{{ stats.absent }}</h4>
                                            <span class="text-muted small">Absent</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="text-center">
                                            <h4 class="text-warning">{{ stats.late }}</h4>
                                            <span class="text-muted small">Late</span>
                                        </div>
                                    </div>
                                    <div class="col-12 mt-2 text-center">
                                        <div class="progress" style="height: 10px;">
                                          <div class="progress-bar {% if stats.percentage >= 75 %}bg-success{% elif stats.percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                               role="progressbar" style="width: {{ stats.percentage|floatformat:0 }}%;"
                                               aria-valuenow="{{ stats.percentage|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
                                           </div>
                                        </div>
                                        <span class="fw-bold {% if stats.percentage < 75 %} text-danger {% endif %}">
                                            {{ stats.percentage|floatformat:1 }}% Attendance
                                        </span>
                                        {% if stats.percentage < 75 %}
                                            <i class="bi bi-exclamation-triangle text-danger" title="Attendance below 75%"></i>
                                        {% endif %}
                                    </div>
                                {% endwith %}
                             {% endif %}
                            {% endwith %}
                         {% else %}
                             <p class="text-center text-muted fst-italic">Select a course above to see detailed stats.</p>
                             <h6 class="text-center mt-3">Overall Averages (Current Semester):</h6>
                              <div class="row mt-2">
                                  {% with overall=course_stats.values|average_stats %} {# Custom template tag needed #}
                                    <div class="col-md-3 col-6 text-center"><h5 class="text-secondary">{{ overall.total|floatformat:0 }}</h5><small>Avg. Classes</small></div>
                                    <div class="col-md-3 col-6 text-center"><h5 class="text-success">{{ overall.present|floatformat:0 }}</h5><small>Avg. Present</small></div>
                                    <div class="col-md-3 col-6 text-center"><h5 class="text-danger">{{ overall.absent|floatformat:0 }}</h5><small>Avg. Absent</small></div>
                                    <div class="col-md-3 col-6 text-center"><h5 class="text-warning">{{ overall.late|floatformat:0 }}</h5><small>Avg. Late</small></div>
                                    <div class="col-12 mt-2 text-center">
                                         <span class="fw-bold {% if overall.percentage < 75 %} text-danger {% endif %}">
                                            {{ overall.percentage|floatformat:1 }}% Overall Attendance
                                        </span>
                                        {% if overall.percentage < 75 %}
                                            <i class="bi bi-exclamation-triangle text-danger" title="Overall attendance below 75%"></i>
                                        {% endif %}
                                    </div>
                                  {% endwith %}
                              </div>
                         {% endif %}
                     </div>
                 </div>
            </div>
        </div><!-- End Filter and Summary -->

        <!-- Attendance Records List -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Attendance Records {% if selected_course %}(Filtered){% endif %}</h5>

                    {% include 'components/alerts.html' %}

                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable-custom">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">Course</th>
                                    <th scope="col">Topic Covered</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records_page %}
                                <tr>
                                    <th scope="row">{{ forloop.counter0|add:records_page.start_index }}</th>
                                    <td>{{ record.attendance.date|date:"M d, Y" }}</td>
                                    <td>{{ record.attendance.course_allocation.course.code }}</td>
                                    <td>{{ record.attendance.topic_covered|truncatechars:50 }}</td>
                                    <td>
                                        {% if record.status == 'present' %}
                                            <span class="badge bg-success">Present</span>
                                        {% elif record.status == 'absent' %}
                                            <span class="badge bg-danger">Absent</span>
                                        {% elif record.status == 'late' %}
                                            <span class="badge bg-warning text-dark">Late</span>
                                        {% else %}
                                             <span class="badge bg-secondary">{{ record.status|title }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No attendance records found{% if selected_course %} for the selected course{% endif %}.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Attendance Records Table -->

                     {% include 'components/pagination.html' with page_obj=records_page %}

                </div>
            </div>

        </div> <!-- End Attendance Records List -->
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{# Custom Template Tag/Filter needed for average_stats #}
{# Example (put in a templatetags file like attendance_tags.py):


#}
<script>
    // Simple Datatable Initialization if needed
    document.addEventListener('DOMContentLoaded', () => {
        const customTable = document.querySelector('.datatable-custom');
        if (customTable) {
            new simpleDatatables.DataTable(customTable, {
                searchable: false, // Use form filter
            });
        }
    });
</script>
{% endblock %}
