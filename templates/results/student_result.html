{% extends 'base/base_student.html' %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}
{% load result_extras %}  {# ADD THIS LINE #}

{% block title %}My Results | {{ school_info.school_name }}{% endblock %}

{% block main %}
<div class="pagetitle">
    <h1>My Results</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">Results</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <!-- Filters and GPA/CGPA -->
        <div class="col-lg-12">
             <div class="card">
                 <div class="card-body">
                    <h5 class="card-title pb-0">View Results</h5>
                     <!-- Filter Form -->
                    <form method="get" class="row g-3 mb-3 align-items-end" id="resultFilterForm">
                        <div class="col-md-4">
                            <label for="session" class="form-label form-label-sm">Session</label>
                            <select id="session" name="session" class="form-select form-select-sm">
                                <option value="">All Sessions</option>
                                {% for s in sessions %}
                                <option value="{{ s.id }}" {% if s.id == selected_session %}selected{% endif %}>{{ s.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-4">
                            <label for="semester" class="form-label form-label-sm">Semester</label>
                            <select id="semester" name="semester" class="form-select form-select-sm">
                                <option value="">All Semesters</option>
                                {% for sem in semesters %}
                                <option value="{{ sem.id }}" {% if sem.id == selected_semester %}selected{% endif %}>{{ sem.get_name_display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                             <button type="submit" class="btn btn-secondary btn-sm w-100"><i class="bi bi-filter"></i> Filter</button>
                        </div>
                         <div class="col-md-2">
                             <a href="{% url 'results:student_result' %}" class="btn btn-outline-secondary btn-sm w-100">Clear</a>
                         </div>
                    </form>

                     <hr>

                     <!-- GPA/CGPA Display -->
                     <div class="row text-center mb-3">
                         <div class="col-md-6 border-end">
                             <h3 class="text-primary fw-bold" id="gpaDisplay">{{ gpa|floatformat:2|default:"N/A" }}</h3>
                             <span class="text-muted small">
                                 {% if selected_session and selected_semester %}
                                     GPA (Filtered View)
                                 {% elif selected_session %}
                                     GPA (Session Total)
                                 {% else %}
                                     GPA (All Results)
                                 {% endif %}
                             </span>
                         </div>
                         <div class="col-md-6">
                              <h3 class="text-success fw-bold" id="cgpaDisplay">{{ cgpa|floatformat:2|default:"N/A" }}</h3>
                             <span class="text-muted small">Cumulative GPA (CGPA)</span>
                         </div>
                     </div>
                 </div>
            </div>
        </div><!-- End Filters and GPA/CGPA -->

        <!-- Results Table -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                     <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">
                            {% if selected_session and selected_semester %}
                                Results for Selected Period
                            {% elif selected_session %}
                                Results for Selected Session
                            {% else %}
                                All Verified Results
                            {% endif %}
                        </h5>
                        <div>
                             {% if results %}
                            <a href="{% url 'results:result_slip_download' %}?session={{ selected_session|default:'' }}&semester={{ selected_semester|default:'' }}"
                               class="btn btn-info btn-sm text-white {% if not selected_session or not selected_semester %}disabled{% endif %}"
                               title="{% if not selected_session or not selected_semester %}Select both Session and Semester to download slip{% else %}Download Result Slip{% endif %}">
                                <i class="bi bi-download me-1"></i> Download Slip
                            </a>
                             <a href="{% url 'results:transcript_download' %}" class="btn btn-secondary btn-sm" title="Download Full Transcript">
                                <i class="bi bi-file-earmark-pdf me-1"></i> Transcript
                            </a>
                             {% endif %}
                        </div>
                    </div>

                    {% include 'components/alerts.html' %}

                    {% if results %}
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-hover table-sm results-table">
                            <thead>
                                <tr class="text-center">
                                    <th>#</th>
                                    <th>Course Code</th>
                                    <th>Course Title</th>
                                    <th>Units</th>
                                    <th>CA</th>
                                    <th>Exam</th>
                                    <th>Total</th>
                                    <th>Grade</th>
                                    <th>GP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr class="text-center">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ result.course.code }}</td>
                                    <td class="text-start">{{ result.course.title }}</td>
                                    <td>{{ result.course.credit_units }}</td>
                                    <td>{{ result.ca_score|floatformat:1 }}</td>
                                    <td>{{ result.exam_score|floatformat:1 }}</td>
                                    <td class="fw-bold">{{ result.total_score|floatformat:1 }}</td>
                                    <td class="fw-bold grade-cell grade-{{ result.grade }}">{{ result.grade }}</td>
                                    <td>{{ result.grade_point|floatformat:1 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                             <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Total Units:</td>
                                    <td class="text-center fw-bold">{{ total_units }}</td>
                                    <td colspan="5"></td>
                                </tr>
                                 <tr>
                                    <td colspan="3" class="text-end fw-bold">GPA:</td>
                                    <td colspan="6" class="fw-bold">{{ gpa|floatformat:2 }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                     <div class="alert alert-light text-center mt-3" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        No verified results found matching your selection. Results are usually available after they have been approved by the department.
                     </div>
                    {% endif %}

                </div>
            </div>
        </div> <!-- End Results Table -->
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<style>
.results-table th, .results-table td {
    vertical-align: middle;
    font-size: 0.9rem;
    padding: 0.5rem;
}
.grade-cell { font-size: 1.1em; }
.grade-A { color: var(--bs-success); }
.grade-B { color: var(--bs-primary); }
.grade-C { color: var(--bs-info); }
.grade-D { color: var(--bs-warning); }
.grade-E { color: var(--bs-secondary); }
.grade-F { color: var(--bs-danger); }
</style>
<script>
    // Optional: Add AJAX to update GPA/CGPA on filter change without reload
    document.getElementById('resultFilterForm')?.addEventListener('submit', function() {
        // Could potentially intercept, fetch results via AJAX, update table and GPA/CGPA display
        // For simplicity, current implementation relies on page reload via GET request
    });

    // Disable download button if no session/semester selected
    const downloadBtn = document.querySelector('a[href*="result_slip_download"]');
    const sessionSelect = document.getElementById('session');
    const semesterSelect = document.getElementById('semester');
    if (downloadBtn && sessionSelect && semesterSelect) {
        // Check on page load
        function updateDownloadButton() {
            if (!sessionSelect.value || !semesterSelect.value) {
                downloadBtn.classList.add('disabled');
                downloadBtn.setAttribute('aria-disabled', 'true');
            } else {
                downloadBtn.classList.remove('disabled');
                downloadBtn.removeAttribute('aria-disabled');
            }
        }

        updateDownloadButton();

        // Update on selection change
        sessionSelect.addEventListener('change', updateDownloadButton);
        semesterSelect.addEventListener('change', updateDownloadButton);
    }
</script>
{% endblock %}